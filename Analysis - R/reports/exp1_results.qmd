---
title: "exp1_results"
format: docx
lang: en-GB
editor: 
  markdown:
      wrap: 62
---

```{r libraries }
#| include: FALSE
library(tidyverse)
# library(ggpp) # not used?
library(gt)
library(patchwork)
```

```{r load data }
#| include: FALSE
list.files("../data/raw/experiment1", pattern = "*.csv", full.names = T) -> fnames

map_df(fnames, \(x){
  read_csv(x)
}) -> data
```


```{r transformation}
#| include: FALSE
# Pre-transformation
data |>
  mutate(rt = as.integer(ifelse( rt == "null", NA, rt ))) -> data

# Select the relevant columns & rows
data |>
  select(id, trial_info, inducer_run, correct_response, rt, congruent) |>
  filter(trial_info == "Diagnostic trial" | trial_info == "Inducer trial") -> d
```


```{r exclusion--}
#| include: FALSE
loss <- list()
loss$data_trials <- nrow(d)
```

```{r exclusion- accuracy less 70 percent }
#| include: FALSE
d |>
  filter( trial_info == "Diagnostic trial" | trial_info == "Inducer trial" ) |>
  group_by( id ) |>
  summarize( acc = sum(correct_response, na.rm = TRUE) / length( !is.na(correct_response) ) ) |>
  filter( acc < .7 ) |>
  pull( id ) -> loss$exclude_par

loss[["exclude_par_trials"]] <- length( d$rt[d$id == loss$exclude_par] )
loss[["exclude_par_pct"]] <- length( d$rt[d$id == loss$exclude_par] ) / loss$data_trials * 100

d |> filter( !(id %in% loss$exclude_par) ) -> d
``` 

In total, `r length(loss[["exclude_par"]])` `r ifelse(length(loss[["data_trials"]]) > 1, "participants", "participant")` where excluded due to low accuracy (> 70%). Resulting in a loss of `r loss[["exclude_par_pct"]]` percent of the data.

```{r exclusion- due to high SD & NA responses}
#| include: FALSE

# Removing trials more than 2.5 SD (from individual mean) & NA RT 
d |>
  group_by(id) |>
  mutate(rt_crit = ifelse( trial_info == "Diagnostic trial",
                           mean( rt, na.rm = TRUE ) + sd( rt, na.rm = TRUE ) * 2.5,
                           NA ),
         retain_trials = ifelse(
           # Remove deviations more than 2.5 SD
           rt >= rt_crit & trial_info == "Diagnostic trial" |
             # AND remove slow responses
             is.na(rt) & trial_info == "Diagnostic trial",
                             0, 1 ) ) -> d

sum(d$retain_trials == 0) -> loss[["rt_sd_trials"]]
sum(d$retain_trials == 0) / loss$data_trials * 100 -> loss[["rt_sd_pct"]]

d |> 
  filter( retain_trials == 1 ) -> d
```

Furthermore, `r loss[["rt_sd_trials"]]` trials were lost due to deviating (2.5 SD) response times and none response(s). Representing a loss of `r round(loss[["rt_sd_pct"]], 2)` percent of the data. 

```{r exclusion- only diag-trials followed by a correct inducer-trial}
#| include: FALSE
d |>
  mutate( valid_trials = case_when( trial_info=="Inducer trial" & correct_response==1 ~ 1,
                                    trial_info=="Inducer trial" & correct_response==0 ~ 0,
                                    T ~ NA ) ) |>
  fill(valid_trials, .direction = "up") -> d

sum(d$valid_trials==0) -> loss[["inducer_fail_trials"]]
sum(d$valid_trials==0) / loss$data_trials * 100 -> loss[["inducer_fail_pct"]]

d |> filter( valid_trials == 1 ) -> d
```

Lastly, `r round(loss[["inducer_fail_trials"]], 2)` trials were removed due to a wrong response on the inducer trial. Representing a loss of `r round(loss[["inducer_fail_pct"]], 2)` percent of the data. 

A total of `r loss$exclude_par_trials + loss$rt_sd_trials + loss$inducer_fail_trials` trials were lost. Representing a loss of `r round(loss$exclude_par_pct + loss$rt_sd_pct + loss$inducer_fail_pct, 2)` percent of the data. 


```{r data summary}
#| include: FALSE

d |>
  filter(trial_info=="Diagnostic trial") |>
  group_by(id, congruent) |>
  summarize(rt = mean(rt, na.rm = TRUE),
            pct = sum(correct_response==1) / length(correct_response)) |>
  pivot_wider( names_from = congruent, values_from = c(rt, pct) ) |>
  ungroup() -> d2
```

```{r RT tables}
#| echo: false

# Freq:
## response times
d2 |>
  summarise(
    name = "RT",
    m_incongruent = mean(rt_FALSE),
    sd_incongruent = sd(rt_FALSE),
    m_congruent = mean(rt_TRUE),
    sd_congruent = sd(rt_TRUE),
    Mdiff = mean( rt_FALSE - rt_TRUE),
    t = t.test(  rt_FALSE, rt_TRUE, paired = TRUE, alternative = "greater" )[["statistic"]],
    df = t.test( rt_FALSE, rt_TRUE, paired = TRUE, alternative = "greater" )[["parameter"]],
    p = t.test(  rt_FALSE, rt_TRUE, paired = TRUE, alternative = "greater" )[["p.value"]],
    p.cor = p.adjust(p, "bonferroni", n=2),
    )  -> d_rt
  # incong is greater than cong.

## proportion correct trials
d2 |>
  summarise(
    name = "PCT",
    m_incongruent = mean( pct_FALSE ),
    sd_incongruent = sd( pct_FALSE ),
    m_congruent = mean( pct_TRUE ),
    sd_congruent = mean( pct_TRUE ),
    Mdiff = mean( pct_FALSE - pct_TRUE ),
    t = t.test(  pct_FALSE, pct_TRUE, paired = TRUE, alternative = "less" )[["statistic"]],
    df = t.test( pct_FALSE, pct_TRUE, paired = TRUE, alternative = "less" )[["parameter"]],
    p = t.test(  pct_FALSE, pct_TRUE, paired = TRUE, alternative = "less" )[["p.value"]], 
    p.cor = p.adjust(p, "bonferroni", n=2),
  ) -> d_pct
  # incong has less correct trials than cong. 


# add bayesian row? 

```


```{r stat table}
#| echo: false

rbind(d_rt, d_pct) |>
  mutate(p.cor = p.adjust(p, "bonferroni"),
           # p correction
         ps = case_when(p < .05 ~ "*", p < 0.01 ~ "**", p < 0.001 ~ "***", T ~ ""),
           # Sig. indicator 
         em1 = "", em2="") |>
          # empty  spacers
  gt() |>
  tab_spanner(  "Incongruent", c(m_incongruent, sd_incongruent) ) |>
  cols_label(   m_incongruent = "M", sd_incongruent = "SD" ) |>
  tab_spanner(  "Congruent", c(m_congruent, sd_congruent) ) |>
  cols_label(   m_congruent = "M",  sd_congruent = "SD" ) |>
  tab_spanner(  "Test", c(t, df, p.cor, ps) ) |>
  cols_move(    "em1", sd_incongruent) |>
  cols_move(    "em2", Mdiff) |>
  cols_label(   ps = "", em1="",em2="", t = md("*t*"), p.cor = md("*p*")) |>
  cols_hide(    "p") |>
  #fmt_markdown() |>
    # Doesnt play nice with .docx (?)
  fmt_number()
  # These do not work, for some reason.
  # tab_footnote( "*p < 0.05, **p < 0.01, ***p < 0.001" ) |>
  # tab_footnote( "P's are Bonferroni corrected for 2 tests", placement="left" ) |>
```


```{r rt and percent plot}
#| echo: false
#| fig-dpi: 300

d2 |>
  mutate(congruent = ifelse(str_detect(congruent, "TRUE"), "Congruent", "Incongruent")) |>
  ggplot(aes(x = congruent, y = rt))+
  geom_point(position = position_dodgenudge(.05, x = .05), alpha = .35)+
  geom_line(aes(group = id), position = position_dodgenudge(.05, x=.05), alpha = .4)+
  stat_summary(fun.data = mean_se, col = "red")+
  labs(x = "", y = "Response time (ms)") -> p1

d2 |>
  mutate(congruent = ifelse(str_detect(congruent, "TRUE"), "Congruent", "Incongruent")) |>
  ggplot(aes(x = congruent, y = pct))+
  geom_point(position = position_dodgenudge(.05, x = .05), alpha = .35)+
  geom_line(aes(group = id), position = position_dodgenudge(.05, x=.05), alpha = .4)+
  stat_summary(fun.data = mean_se, col = "red")+
  scale_y_continuous(breaks = seq(0,1, .05), limits = c(.68, 1))+
  labs(x = "", y = "Proportion of correct ") -> p2

p1+p2
```




